pipeline {
    agent any

    environment {
        ANSIBLE_KEY = '/var/lib/jenkins/.ssh/MYKAFKA.pem'
        ANSIBLE_USER = 'ubuntu'
        INVENTORY = 'kafkacluster/aws_ec2.yml'
        PLAYBOOK = 'kafkacluster/site.yml'
    }

    stages {

        stage('Checkout SCM') {
            steps {
                echo "Checking out Git repository..."
                checkout([$class: 'GitSCM', 
                          branches: [[name: '*/main']], 
                          userRemoteConfigs: [[url: 'https://github.com/AnithaAnnem/my-kafka-task.git']]
                ])
            }
        }

        stage('Run Ansible Playbook') {
            steps {
                echo "Running Ansible playbook to deploy Kafka cluster..."
                sh '''
                export ANSIBLE_HOST_KEY_CHECKING=False
                ansible-playbook -i $INVENTORY $PLAYBOOK -u $ANSIBLE_USER --private-key $ANSIBLE_KEY
                '''
            }
        }

        stage('Verify Services') {
            steps {
                echo "Verifying Zookeeper and Kafka services..."
                // Example: ping each host or check systemctl status
                sh '''
                ssh -i $ANSIBLE_KEY $ANSIBLE_USER@10.0.11.120 "systemctl status zookeeper"
                ssh -i $ANSIBLE_KEY $ANSIBLE_USER@10.0.11.68 "systemctl status zookeeper"
                ssh -i $ANSIBLE_KEY $ANSIBLE_USER@10.0.11.179 "systemctl status zookeeper"
                ssh -i $ANSIBLE_KEY $ANSIBLE_USER@10.0.11.120 "systemctl status kafka"
                ssh -i $ANSIBLE_KEY $ANSIBLE_USER@10.0.11.68 "systemctl status kafka"
                ssh -i $ANSIBLE_KEY $ANSIBLE_USER@10.0.11.179 "systemctl status kafka"
                '''
            }
        }
    }

    post {
        success {
            echo "Kafka cluster deployed successfully!"
        }
        failure {
            echo "Deployment failed. Please check the logs."
        }
        always {
            echo "Cleaning workspace..."
            cleanWs()
        }
    }
}
