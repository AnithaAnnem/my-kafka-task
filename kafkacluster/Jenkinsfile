pipeline {
    agent any

    environment {
        SSH_USER = 'ubuntu'
        SSH_KEY = 'AWS-SSH-key'
        PLAYBOOK = 'kafkacluster/site.yml'
        INVENTORY = 'kafkacluster/aws_ec2.yml'
    }

    stages {

        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }

        stage('Run Ansible Playbook') {
            steps {
                echo 'Running Ansible playbook to deploy Kafka cluster...'
                sh """
                    ansible-playbook -i ${INVENTORY} ${PLAYBOOK} -u ${SSH_USER} --private-key ${SSH_KEY}
                """
            }
        }

        stage('Verify Services') {
            steps {
                echo 'Verifying Kafka and Zookeeper services...'
                sh '''
                    for host in $(ansible -i ${INVENTORY} all --list-hosts | tail -n +2); do
                        ssh -o StrictHostKeyChecking=no -i ${SSH_KEY} ${SSH_USER}@${host} \
                        "systemctl status kafka && systemctl status zookeeper"
                    done
                '''
            }
        }
    }

    post {
        always {
            echo 'Cleaning workspace...'
            cleanWs()
        }
        success {
            echo 'Kafka cluster deployed successfully!'
        }
        failure {
            echo 'Deployment failed. Please check the logs.'
        }
    }
}
